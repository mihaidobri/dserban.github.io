

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">

<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <title>ROSEdu Techblog</title>
    
    <link rel="stylesheet" href="http://rosedu.github.com/techblog/css/styles.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="http://rosedu.github.com/techblog/css/rosedu_links.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="http://rosedu.github.com/techblog/css/syntax.css" type="text/css" charset="utf-8">
  </head>
  <body>
    <div id="header">
      <div id="site_title"><a href="/"><h1>ROSEdu Techblog :: DEMO</h1></a></div>
      <div id="site_tagline"><h4>open techblog: Operation not permitted.</h4></div>
    </div>
    <div id="meta">
      

<div class="rss">
    <img src="http://rosedu.github.com/techblog/img/rss.png" alt="Subscribe to RSS Feed"/>
    <img src="http://rosedu.github.com/techblog/img/reddit.png" alt="Submit to Reddit"/>
    <img src='http://rosedu.github.com/techblog/img/twitter.png' alt='Submit to Twitter'/>
</div>
<hr/>
<div class="meta-header">Readability</div>
<ul>
  <li><a href='javascript:void($("#meta").hide());'>Hide this sidebar</a></li>
</ul>
<hr/>
<div class="links">
  <div class="meta-header">Blog Navigation</div>
  <ul>
    <li><a href='http://rosedu.github.com/techblog/'>Home</a></li>
    <li><a href='http://rosedu.github.com/techblog/about'>About</a></li>
    <li><a href='http://rosedu.github.com/techblog/archive'>Archive</a></li>
    <li><a href='http://rosedu.github.com/techblog/tags'>Tags</a></li>
    <li><a href='http://rosedu.github.com/techblog/posting'>Posting</a></li>
  </ul>
  <hr/>
  <div class="meta-header">Latest Posts</div>
  <ul>
	
          <li><a href="http://rosedu.github.com/techblog/a-weird-behaviour-in-c.html">A Weird Behaviour Of C</a></li>
	
          <li><a href="http://rosedu.github.com/techblog/git-useful-aliases.html">Git - Useful Aliases</a></li>
	
          <li><a href="http://rosedu.github.com/techblog/gnu-make.html">GNU Make</a></li>
	
  </ul>
  <hr/>
  <div class="meta-header">Powered by:</div>
  <ul>
    <li><a href='http://rosedu.org'>ROSEdu</a></li>
    <li><a href='http://jekyllrb.com/'>Jekyll</a></li>
  </ul>
  <hr/>
  <div class="meta-header">People:</div>
  <ul>
    <li><a href='http://pgraycode.wordpress.com/'>Mihai Maruseac</a></li>
    <li><a href='http://danf.wordpress.com/'>Dan Filimon</a></li>
    <li><a href='http://swarm.cs.pub.ro/~razvan/blog/'>Răzvan Deaconescu</a></li>
    <li><a href='http://alexj.info/category/tech-stuff/'>Alex Juncu</a></li>
    <li><a href='http://ddvlad.wordpress.com/'>Vlad Dogaru</a></li>
    <li><a href='http://interruptenable.blogspot.com/'>Daniel Băluță</a></li>
    <li><a href='http://swarm.cs.pub.ro/~laura/blog/'>Laura Vasilescu</a></li>
  </ul>
</div>

    </div>
    <div id="content">
      




<div id="container">
  <div class="entry-content">
    



<h2 class="clear">
  
  <a class="post_title" href="http://rosedu.github.com/techblog/a-weird-behaviour-in-c.html" title="A Weird Behaviour Of C">A Weird Behaviour Of C</a>
  
</h2>
<span class="date" 
  title="2012-07-29T00:00:00-07:00">
  <span class="published">Published on </span>
  <span class="day">29</span>
  <span class="month">July</span>
  <span class="year">2012</span>
  
  by
  <span class="author">Mihai Maruseac</span>
  
</span>


    <p>Let us start from a common mistake made by programmers learning simple data structures in C. The following code is an implementation for simple linked lists of integers in C.</p>
<div class='highlight'><pre><code class='cpp'><span class='cp'>#include &lt;stdio.h&gt;</span>
<span class='cp'>#include &lt;stdlib.h&gt;</span>

<span class='k'>struct</span> <span class='n'>queue</span> <span class='p'>{</span>
	<span class='kt'>int</span> <span class='n'>elm</span><span class='p'>;</span>
	<span class='k'>struct</span> <span class='n'>queue</span><span class='o'>*</span> <span class='n'>next</span><span class='p'>;</span>
<span class='p'>};</span>

<span class='k'>struct</span> <span class='n'>queue</span><span class='o'>*</span> <span class='n'>init</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='k'>struct</span> <span class='n'>queue</span> <span class='o'>*</span><span class='n'>q</span> <span class='o'>=</span> <span class='n'>calloc</span><span class='p'>(</span><span class='mi'>1</span><span class='p'>,</span> <span class='k'>sizeof</span><span class='p'>(</span><span class='o'>*</span><span class='n'>q</span><span class='p'>));</span>
	<span class='n'>q</span><span class='o'>-&gt;</span><span class='n'>next</span> <span class='o'>=</span> <span class='n'>q</span><span class='p'>;</span>
	<span class='k'>return</span> <span class='n'>q</span><span class='p'>;</span>
<span class='p'>}</span>

<span class='kt'>void</span> <span class='n'>add</span><span class='p'>(</span><span class='k'>struct</span> <span class='n'>queue</span> <span class='o'>*</span><span class='n'>q</span><span class='p'>,</span> <span class='kt'>int</span> <span class='n'>x</span><span class='p'>)</span>
<span class='p'>{</span>
	<span class='k'>struct</span> <span class='n'>queue</span> <span class='o'>*</span><span class='n'>n</span> <span class='o'>=</span> <span class='n'>calloc</span><span class='p'>(</span><span class='mi'>1</span><span class='p'>,</span> <span class='k'>sizeof</span><span class='p'>(</span><span class='o'>*</span><span class='n'>n</span><span class='p'>));</span>
	<span class='k'>struct</span> <span class='n'>queue</span> <span class='o'>*</span><span class='n'>head</span> <span class='o'>=</span> <span class='n'>q</span><span class='p'>;</span>

	<span class='n'>n</span><span class='o'>-&gt;</span><span class='n'>elm</span> <span class='o'>=</span> <span class='n'>x</span><span class='p'>;</span>
	<span class='n'>n</span><span class='o'>-&gt;</span><span class='n'>next</span> <span class='o'>=</span> <span class='n'>head</span><span class='p'>;</span>
	<span class='k'>while</span> <span class='p'>(</span><span class='n'>q</span><span class='o'>-&gt;</span><span class='n'>next</span> <span class='o'>!=</span> <span class='n'>head</span><span class='p'>)</span>
		<span class='n'>q</span> <span class='o'>=</span> <span class='n'>q</span><span class='o'>-&gt;</span><span class='n'>next</span><span class='p'>;</span>
	<span class='n'>q</span><span class='o'>-&gt;</span><span class='n'>next</span> <span class='o'>=</span> <span class='n'>n</span><span class='p'>;</span>
<span class='p'>}</span>

<span class='kt'>int</span> <span class='n'>pop</span><span class='p'>(</span><span class='k'>struct</span> <span class='n'>queue</span> <span class='o'>*</span><span class='n'>q</span><span class='p'>)</span>
<span class='p'>{</span>
	<span class='kt'>int</span> <span class='n'>x</span> <span class='o'>=</span> <span class='n'>q</span><span class='o'>-&gt;</span><span class='n'>next</span><span class='o'>-&gt;</span><span class='n'>elm</span><span class='p'>;</span>
	<span class='k'>struct</span> <span class='n'>queue</span> <span class='o'>*</span><span class='n'>tmp</span> <span class='o'>=</span> <span class='n'>q</span><span class='o'>-&gt;</span><span class='n'>next</span><span class='p'>;</span>
	<span class='n'>q</span><span class='o'>-&gt;</span><span class='n'>next</span> <span class='o'>=</span> <span class='n'>tmp</span><span class='o'>-&gt;</span><span class='n'>next</span><span class='p'>;</span>
	<span class='n'>free</span><span class='p'>(</span><span class='n'>tmp</span><span class='p'>);</span>
	<span class='k'>return</span> <span class='n'>x</span><span class='p'>;</span>
<span class='p'>}</span>

<span class='kt'>void</span> <span class='n'>free_q</span><span class='p'>(</span><span class='k'>struct</span> <span class='n'>queue</span> <span class='o'>*</span><span class='n'>q</span><span class='p'>)</span>
<span class='p'>{</span>
	<span class='k'>struct</span> <span class='n'>queue</span> <span class='o'>*</span><span class='n'>tmp</span><span class='p'>;</span>
	<span class='k'>while</span> <span class='p'>(</span><span class='n'>q</span><span class='o'>-&gt;</span><span class='n'>next</span> <span class='o'>!=</span> <span class='n'>q</span><span class='p'>)</span> <span class='p'>{</span>
		<span class='n'>tmp</span> <span class='o'>=</span> <span class='n'>q</span><span class='o'>-&gt;</span><span class='n'>next</span><span class='p'>;</span>
		<span class='n'>free</span><span class='p'>(</span><span class='n'>q</span><span class='p'>);</span>
		<span class='n'>q</span> <span class='o'>=</span> <span class='n'>tmp</span><span class='p'>;</span>
	<span class='p'>}</span>
	<span class='n'>free</span><span class='p'>(</span><span class='n'>q</span><span class='p'>);</span>
<span class='p'>}</span>

<span class='kt'>int</span> <span class='n'>main</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='k'>struct</span> <span class='n'>queue</span> <span class='o'>*</span><span class='n'>q</span> <span class='o'>=</span> <span class='n'>init</span><span class='p'>();</span>
	<span class='n'>add</span><span class='p'>(</span><span class='n'>q</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>);</span>
	<span class='n'>add</span><span class='p'>(</span><span class='n'>q</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>);</span>
	<span class='n'>printf</span><span class='p'>(</span><span class='s'>&quot;%d%d</span><span class='se'>\n</span><span class='s'>&quot;</span><span class='p'>,</span> <span class='n'>pop</span><span class='p'>(</span><span class='n'>q</span><span class='p'>),</span> <span class='n'>pop</span><span class='p'>(</span><span class='n'>q</span><span class='p'>));</span>
	<span class='n'>free_q</span><span class='p'>(</span><span class='n'>q</span><span class='p'>);</span>
	<span class='k'>return</span> <span class='mi'>0</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>The idea is simple: we insert <code>4</code> and <code>2</code> into the queue and expect the output to be <code>42</code>, the digits being output in the order of their insertion into the queue.</p>

<p>However, running the program, we have a big surprise:</p>

<pre><code>$ gcc -Wall -Wextra 1.c -g -o 1-gcc
$ clang -Wall -Wextra 1.c -g -o 1-clang
$ ./1-gcc 
24
$ ./1-clang 
42</code></pre>

<p>Let&#8217;s ignore for now the fact that <a href='http://clang.llvm.org/' title='clang'>clang</a> gives the correct response and let&#8217;s answer this question: What went wrong? The queue implementation seems correct but let&#8217;s replace it by a dummy implementation:</p>
<div class='highlight'><pre><code class='cpp'><span class='cp'>#include &lt;stdio.h&gt;</span>
<span class='cp'>#include &lt;stdlib.h&gt;</span>

<span class='kt'>int</span> <span class='n'>x</span><span class='p'>;</span>

<span class='kt'>int</span> <span class='n'>inc</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='n'>x</span><span class='o'>++</span><span class='p'>;</span>
	<span class='k'>return</span> <span class='n'>x</span><span class='p'>;</span>
<span class='p'>}</span>

<span class='kt'>int</span> <span class='n'>dec</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='n'>x</span><span class='o'>--</span><span class='p'>;</span>
	<span class='k'>return</span> <span class='n'>x</span><span class='p'>;</span>
<span class='p'>}</span>

<span class='kt'>int</span> <span class='n'>main</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='n'>inc</span><span class='p'>();</span>
	<span class='n'>inc</span><span class='p'>();</span>
	<span class='n'>printf</span><span class='p'>(</span><span class='s'>&quot;%d%d</span><span class='se'>\n</span><span class='s'>&quot;</span><span class='p'>,</span> <span class='n'>dec</span><span class='p'>(),</span> <span class='n'>dec</span><span class='p'>());</span>
	<span class='k'>return</span> <span class='mi'>0</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>Basically, we have removed the queue and replaced it by it&#8217;s length, stored in the global <code>x</code> variable. The expected output is <code>10</code>.</p>

<pre><code>$ clang -Wall -Wextra 2.c -g -o 2-clang
$ gcc -Wall -Wextra 2.c -g -o 2-gcc
$ ./2-gcc 
01
$ ./2-clang 
10</code></pre>

<p>The output is consistent with the above example. Thus, the problem is not in our queue implementation. It must be somewhere else.</p>

<p>Before starting to shout that <code>printf</code> or <code>gcc</code> or <code>clang</code> is buggy, let us read <a href='http://www.open-std.org/jtc1/sc22/wg14/www/standards' title='C standards'>the C standard</a>:</p>

<blockquote>
<p><strong>unspecified behavior</strong>: use of an unspecified value, or other behavior where this International Standard provides two or more possibilities and imposes no further requirements on which is chosen in any instance</p>

<p><strong>EXAMPLE</strong> An example of unspecified behavior is the order in which the arguments to a function are evaluated.</p>
</blockquote>

<p>This explains why the two compilers were allowed to give different results, while being both correct.</p>

<p>If we want more informations, we can compare the generated assembly code of the two compilers. The <code>gcc</code> version is below (only the relevant snippet):</p>

<pre><code>call    inc
movl    $0, %eax
call    inc
movl    $0, %eax
call    dec
movl    %eax, %ebx
movl    $0, %eax
call    dec
movl    %eax, %ecx
movl    $.LC0, %eax
movl    %ebx, %edx
movl    %ecx, %esi
movq    %rax, %rdi
movl    $0, %eax
call    printf</code></pre>

<p>For comparation, the <code>clang</code> version is:</p>

<pre><code>callq   inc
movl    %eax, -8(%rbp)          # 4-byte Spill
callq   inc
movl    %eax, -12(%rbp)         # 4-byte Spill
callq   dec
movl    %eax, -16(%rbp)         # 4-byte Spill
callq   dec
leaq    .L.str, %rdi
movl    -16(%rbp), %esi         # 4-byte Reload
movl    %eax, %edx
movb    $0, %al
callq   printf</code></pre>

<p>The understanding of the assembly code is left as an exercise to the reader. It is easy to see that <code>clang</code> uses the stack to store the results.</p>

<p>Both snippets were obtained using no optimization. As an exercise, try to observe the effect of each optimization level on the generated code and explain it.</p>

<p>Let&#8217;s go on. In the above snippet we have used functions to increment and decrement the global value. Let us rewrite that code:</p>
<div class='highlight'><pre><code class='cpp'><span class='cp'>#include &lt;stdio.h&gt;</span>
<span class='cp'>#include &lt;stdlib.h&gt;</span>

<span class='kt'>int</span> <span class='n'>main</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='kt'>int</span> <span class='n'>x</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span>
	<span class='n'>x</span><span class='o'>++</span><span class='p'>;</span>
	<span class='n'>x</span><span class='o'>++</span><span class='p'>;</span>
	<span class='n'>printf</span><span class='p'>(</span><span class='s'>&quot;%d%d</span><span class='se'>\n</span><span class='s'>&quot;</span><span class='p'>,</span> <span class='o'>--</span><span class='n'>x</span><span class='p'>,</span> <span class='o'>--</span><span class='n'>x</span><span class='p'>);</span>
	<span class='k'>return</span> <span class='mi'>0</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>Here, we have another suprise:</p>

<pre><code>$ ./3-gcc 
00
$ ./3-clang 
10</code></pre>

<p>The <code>gcc</code> version printed only the final value of <code>x</code>, twice. Clearly, there is something happening here. Let&#8217;s look closer.</p>

<p>Looking at the generated assembly, we see that <code>gcc</code> generated this code:</p>

<pre><code>movl    $0, -4(%rbp)
addl    $1, -4(%rbp)
addl    $1, -4(%rbp)
subl    $1, -4(%rbp)
subl    $1, -4(%rbp)
movl    $.LC0, %eax
movl    -4(%rbp), %edx
movl    -4(%rbp), %ecx
movl    %ecx, %esi
movq    %rax, %rdi
movl    $0, %eax
call    printf</code></pre>

<p>On the other hand, <code>clang</code> generated:</p>

<pre><code>movl    -8(%rbp), %eax
addl    $1, %eax
movl    %eax, -8(%rbp)
movl    -8(%rbp), %eax
addl    $1, %eax
movl    %eax, -8(%rbp)
movl    -8(%rbp), %eax
addl    $4294967295, %eax       # imm = 0xFFFFFFFF
movl    %eax, -8(%rbp)
movl    -8(%rbp), %ecx
addl    $4294967295, %ecx       # imm = 0xFFFFFFFF
movl    %ecx, -8(%rbp)
movl    %eax, %esi
movl    %ecx, %edx
movb    $0, %al
callq   printf</code></pre>

<p>One can easily see that <code>gcc</code> did the operations on <code>x</code> before starting the function call sequence while <code>clang</code> interleaved stack operations with operations on <code>x</code> such that the output is the one we would expect. Not to mention the fact that substraction was replaced by addition.</p>

<p>However, what allows the compilers to do this? Luckily, we have compiled with warnings on:</p>

<pre><code>$ clang -Wall -Wextra 3.c -g -o 3-clang
$ gcc -Wall -Wextra 3.c -g -o 3-gcc
3.c: In function ‘main’:
3.c:9:24: warning: operation on ‘x’ may be undefined [-Wsequence-point]</code></pre>

<p>Reading the standard for sequence points we get:</p>

<blockquote>
<p>Evaluation of an expression may produce side effects. At certain specified points in the execution sequence called sequence points, all side effects of previous evaluations shall be complete and no side effects of subsequent evaluations shall have taken place.</p>
</blockquote>

<p>Reading further, we see that it is an <strong>undefined behaviour</strong> if:</p>

<blockquote>
<p>Between two sequence points, an object is modified more than once, or is modified and the prior value is read other than to determine the value to be stored.</p>
</blockquote>

<p>Lastly, the standard defines a sequence point to be (among other more complex constructs):</p>

<ul>
<li>a call of a function</li>

<li>end of the first operand or <code>&amp;&amp;</code>, <code>||</code>, <code>?</code> and <code>,</code></li>
</ul>

<p>Thus, our side effects in the <code>printf</code> function cause undefined behaviour and unspecified behaviour. Depending on the compiler, the results can be very different. This harms portability and should be avoided.</p>

<p>Before finishing the article, let&#8217;s see another example, using different constructs:</p>
<div class='highlight'><pre><code class='cpp'><span class='cp'>#include &lt;stdio.h&gt;</span>
<span class='cp'>#include &lt;stdlib.h&gt;</span>
<span class='cp'>#include &lt;limits.h&gt;</span>

<span class='kt'>int</span> <span class='n'>main</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='kt'>int</span> <span class='n'>x</span> <span class='o'>=</span> <span class='n'>INT_MAX</span><span class='p'>;</span>
	<span class='kt'>void</span> <span class='o'>*</span><span class='n'>p</span> <span class='o'>=</span> <span class='o'>&amp;</span><span class='n'>x</span><span class='p'>;</span>

	<span class='n'>printf</span><span class='p'>(</span><span class='s'>&quot;%d %d</span><span class='se'>\n</span><span class='s'>&quot;</span><span class='p'>,</span> <span class='n'>x</span><span class='p'>,</span> <span class='n'>x</span> <span class='o'>+</span> <span class='mi'>1</span><span class='p'>);</span>
	<span class='n'>printf</span><span class='p'>(</span><span class='s'>&quot;%p %p</span><span class='se'>\n</span><span class='s'>&quot;</span><span class='p'>,</span> <span class='n'>p</span><span class='p'>,</span> <span class='n'>p</span> <span class='o'>+</span> <span class='mi'>1</span><span class='p'>);</span>

	<span class='k'>return</span> <span class='mi'>0</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>The possible outputs of this code and the reasoning behind are left as an exercise. Use the comments area to provide solutions for all exercises left in this article.</p>

<p>As a rule of thumb, try to limit the use of side effects inside a function call. You don&#8217;t know when you&#8217;ll fall into this trap again.</p>
    <hr/>
  </div>
</div>

<div id="container">
  <div class="entry-content">
    



<h2 class="clear">
  
  <a class="post_title" href="http://rosedu.github.com/techblog/git-useful-aliases.html" title="Git - Useful Aliases">Git - Useful Aliases</a>
  
</h2>
<span class="date" 
  title="2012-06-23T00:00:00-07:00">
  <span class="published">Published on </span>
  <span class="day">23</span>
  <span class="month">June</span>
  <span class="year">2012</span>
  
  by
  <span class="author">Mihai Maruseac</span>
  
</span>


    <p>This is the third article about <a href='http://git-scm.com/' title='Git'>git</a> on this blog. It is highly recommended to read the other two as well: there is <a href='http://techblog.rosedu.org/git-good-practices.html' title='Git good practices'>one</a> about some good practices in using <a href='http://git-scm.com/' title='Git'>git</a> and <a href='http://techblog.rosedu.org/git-speeding-workflow.html' title='Git speeding workflow'>another one</a> about some aliases which will speed up your interaction with the commit history.</p>

<p>The series of articles about <a href='http://git-scm.com/' title='Git'>git</a> continues with a short presentation about two other aliases and the reason why they should be used in order to create better commits.</p>

<h3 id='rebase_instead_of_merge'>Rebase instead of merge</h3>

<p>From time to time we rush to push our changes to the remote repository without thinking of the possibility that another developer had made some commits in the meantime. Luckily, we are announced when this happens:</p>

<pre><code>mihai@keldon:/data/ROSEdu/techblog$ git push
To gitolite@git.rosedu.org:techblog.git
 ! [rejected]        contrib -&gt; contrib (non-fast-forward)
error: failed to push some refs to &#39;gitolite@git.rosedu.org:techblog.git&#39;
hint: Updates were rejected because the tip of your current branch is behind
hint: its remote counterpart. Merge the remote changes (e.g. &#39;git pull&#39;)
hint: before pushing again.
hint: See the &#39;Note about fast-forwards&#39; in &#39;git push --help&#39; for details.</code></pre>

<p>What is a fast-forward update? What we tried to do in the above command was just to update one reference in the upstream repository: we wanted to change the <code>HEAD</code> reference which pointed to a commit &#8211; let&#8217;s call it <code>A</code> &#8211; to another commit, the latest one in our repository &#8211; let&#8217;s call it <code>B</code>.</p>

<p>If and only if <code>B</code> is a descendant of <code>A</code> we have a fast-forward update. Otherwise, the update is non-fast-forward. These definitions generalize to local branches or any other kind of reference updates.</p>

<p>What is the purpose of this distinction? Any fast-forward updated guarantees that the history of <em>both</em> branches is not lost. In contrast, a non-fast-forward update will certainly lose a part of the history.</p>

<p>We need to change our point of view to see this. Let us view the two repositories in a simple diagram showing both branches from the very moment when the local repository was cloned:</p>

<p><img src='./img/gua-1.png' alt='initial-repo' /></p>

<p>The <code>HEAD</code> reference for the remote repository was pointing at commit <code>A</code> and we want to make it to point at commit <code>B</code> which is not a direct descendent of <code>A</code>, thus the update is non-fast-forward.</p>

<p>If <code>git push</code> was allowed to finish successfully in any of the two cases then the history from <code>O</code> up to <code>A</code> would be lost: developers would only see the history from <code>O</code> to <code>B</code> and would work only on top of the <code>B</code> commit. This is why <code>git push</code> failed.</p>

<p>The error message suggests to do a <code>git pull</code> in order to merge the two branches. Let&#8217;s see what will happen when we do this:</p>

<p><img src='./img/gua-2.png' alt='merge commit' /></p>

<p>A merge commit <code>C</code> was created containing changes from both <code>A</code> and <code>B</code>. This is a <em>new</em> commit and it looks like the following one:</p>

<pre><code>mihai@keldon:$ git show 2603167
commit 2603167229a11b8dad6715246041ad29f792308c
Merge: ad4d7a1 6091ae3
Author: Alex Juncu &lt;ajuncu@ixiacom.com&gt;
Date:   Wed Nov 30 15:32:05 2011 +0200

    Merge branch &#39;contrib&#39; of git.rosedu.org:techblog into contrib</code></pre>

<p>There are cases where this merge commit is needed. However, not all instances of the above diagram need a merge commit.</p>

<p>The other alternative is to do a rebase first using <code>git pull --rebase</code> for example. In this case, the following thing will happen: a new commit <code>D</code> will be created containing the set of changes needed to be applied on top of <code>A</code> in order to reach <code>B</code>.</p>

<p><img src='./img/gua-3.png' alt='rebase commit' /></p>

<p>Now, the <code>D</code> commit is already on top of <code>A</code> and the push will be a fast-forward update. This can be seen from the following screen as well:</p>

<pre><code>mihai@keldon:$ git pull --rebase
remote: Counting objects: 5, done.
remote: Compressing objects: 100% (3/3), done.
remote: Total 3 (delta 2), reused 0 (delta 0)
Unpacking objects: 100% (3/3), done.
From git.rosedu.org:techblog
   b557977..38da5d0  contrib    -&gt; origin/contrib
First, rewinding head to replay your work on top of it...
Applying: Add author for first article.</code></pre>

<p>The push will simply update the <code>HEAD</code> reference to point to the <code>D</code> commit.</p>

<p><img src='./img/gua-4.png' alt='update HEAD after rebase commit' /></p>

<p>If the rebase cannot be done because of a merge conflict we are announced of this and the rebase will stop until we resolve it.</p>

<p>There are several ways to make <a href='http://git-scm.com/' title='Git'>git</a> try to always use <code>--rebase</code> when pulling. What I recommend is to create an alias. I have this in <code>~/.gitconfig</code>:</p>

<pre><code>[alias]
        gpr = pull --rebase</code></pre>

<p>This has two benefits: I always try to do a rebase first and I type less. In fact, using TAB completion I have to press only 5 keys for this.</p>

<h3 id='interactive_addition_of_changes'>Interactive addition of changes</h3>

<p>One rule for better <a href='http://git-scm.com/' title='Git'>git</a> commits is to have short and meaningful commits with relevant commit messages. However, it is possible that we have done several unrelated changes to a single file (for example we have updated a comment and added some new code). Issuing a simple <code>git add file</code> will break the above rule.</p>

<p>One solution for this is to use <code>git add --interactive</code>. It is better to use <code>git add --patch</code> though.</p>

<p>Our change will be split in several hunks and each of them will be offered to us with a simple question at the end:</p>

<pre><code>@@ -76,6 +78,10 @@ TODO
     Did you mean this?
             gpr

+TODO: git gdc
+
+TODO: final thoughts
+
 [git]: http://git-scm.com/ &quot;Git&quot;
 [ggp]: http://techblog.rosedu.org/git-good-practices.html &quot;Git good practices&quot;
 [gsw]: http://techblog.rosedu.org/git-speeding-workflow.html &quot;Git speeding workflow&quot;
Stage this hunk [y,n,q,a,d,/,K,g,e,?]? y</code></pre>

<p>We can decide to accept or reject the hunk for this commit or we can split it in several other hunks. We can even edit the hunk if we need this.</p>

<p>In order to speed up typing I have an alias for this as well:</p>

<pre><code>gap = add --patch</code></pre>

<p>I have imprinted in my muscle memory to never type <code>git add</code> but <code>git gap</code>.</p>

<h3 id='conclusions'>Conclusions</h3>

<p>The two aliases presented above help us be a little more proficient with <a href='http://git-scm.com/' title='Git'>git</a> usage. I am using them for several months now and the results are good.</p>
    <hr/>
  </div>
</div>

<div id="container">
  <div class="entry-content">
    



<h2 class="clear">
  
  <a class="post_title" href="http://rosedu.github.com/techblog/gnu-make.html" title="GNU Make">GNU Make</a>
  
</h2>
<span class="date" 
  title="2012-05-08T00:00:00-07:00">
  <span class="published">Published on </span>
  <span class="day">08</span>
  <span class="month">May</span>
  <span class="year">2012</span>
  
  by
  <span class="author">Mihai Tiriplica</span>
  
</span>


    <p>In working with large projects it is necessary to compile from multiple sources. Since this is quite difficult, different tools have been developed to make this task easier. One such tool is GNU Make and the associated executable is <code>make</code>. Make solves compilation from multiple sources problem using the dependency relationships between them, described in a special file usually called <code>Makefile</code>.</p>

<h3 id='syntax'>Syntax</h3>

<p>The file which describes the dependency relationships between project’s sources. It should be named <code>Makefile</code> or <code>makefile</code> and has the following syntax:</p>

<pre><code>target: dependency_list
&lt;tab&gt;command</code></pre>

<p>Usually, the target’s name matches the name of the resulted file, except only those which are <code>.PHONY</code> targets, called virtual targets (they do not generate a specific file). List dependencies include dependencies that are required for target execution. Usually, there are files from which the target will be built. A common mistake is that spaces are used instead of <code>TAB</code>. This will result in an error message when running make. An example Makefile is:</p>

<pre><code>exec:
	gcc foo.c bar.c main.c -o exec</code></pre>

<p>This is not the best way we can use make because it doesn’t describe any dependencies, so every time we run make it will run <code>gcc foo.c bar.c main.c -o
exec</code>, even if there are no modified sources. Better use is the following example:</p>

<pre><code>exec: foo.c bar.c main.c
	gcc foo.c bar.c main.c -o exec</code></pre>

<p>In this case the target <code>exec</code> will run only if a source has changed. Neither this case takes full advantage of the facilities make offers, because modifying a single source leads to compiling all the existing sources. An ideal Makefile describes the lowest level possible dependencies. In our case it is the object file:</p>

<pre><code>exec: foo.o bar.o main.o
	gcc foo.o bar.o main.o -o exec
foo.o: foo.c
	gcc -c foo.c -o foo.o
bar.o: bar.c
	gcc -c bar.c -o bar.o
main.o: main.c
	gcc -c main.c -o main.o</code></pre>

<h3 id='how_it_works'>How it works</h3>

<p>A particular target is executed by running <code>make target</code>. If there is no argument, it will execute the first target described. To execute a target all of his dependencies must be satisfied. For our example, <code>exec</code> target is executed only after <code>foo.o</code>, <code>bar.o</code>, <code>main.o</code>, which are conditioned by <code>foo.c</code>, <code>bar.c</code>, <code>main.c</code>, are obtained.</p>

<h3 id='variables'>Variables</h3>

<p>In Makefile files we can declare variables to replace commonly used sequences or which are changed frequently. The variables’ values are obtained using the character <code>$</code>: <code>$(variable_name)</code>. For the example above, let’s suppose that one of the source files uses functions from <code>math.h</code>. We will declare a variable that is meant to specify that for linking:</p>

<pre><code>LDFLAGS=-lm
exec: foo.o bar.o main.o
	gcc $(LDFLAGS) foo.o bar.o main.o -o exec
foo.o: foo.c
	gcc -c foo.c -o foo.o
bar.o: bar.c
	gcc -c bar.c -o bar.o
main.o: main.c
	gcc -c main.c -o main.o</code></pre>

<p>Make offers several predefined variables, of which the most important are:</p>

<ul>
<li><code>$@</code> - target’s name</li>

<li><code>$^</code> - dependecies list</li>

<li><code>$&lt;</code> - the first dependencie</li>
</ul>

<p>The Makefile above can be written in a more simple way:</p>

<pre><code>CC=gcc
LDFLAGS=-lm
exec: ana.o are.o mere.o
	$(CC) $(LDFLAGS) $^ -o $@
%.o: %.c
	$(CC) -c $&lt; -o $@</code></pre>

<p>Variables in a Makefile can also come from the environment where <code>make</code> is running. While running, make sees each environment variable as a local variable with the same name and the same value. Thus, assigning a value for <code>LDFLAGS</code> variable in the example above can cause changes to any compile command. To convert a local variable in an environment variable in order to use it in other Makefile files we use the <code>export</code> directive:</p>

<pre><code>export variable</code></pre>

<p>Inverse transformation is done using <code>unexport</code>:</p>

<pre><code>unexport variable</code></pre>

<h3 id='phony_target'>.PHONY target</h3>

<p>If we want a target to be marked permanently as out of date we will use the <code>.PHONY</code> target. Let&#8217;s consider that there is a pack target that creates an archive which contains the project’s sources. If there is one source named <code>pack</code> and it does not change, the command associated with this target will not be executed. For this we use <code>.PHONY</code>. Also, by convention all Makefile files contain a <code>.PHONY</code> target called <code>clean</code> used to delete the files obtained from compiling or running the program.</p>

<pre><code>.PHONY: pack
pack:
	zip -r project.zip *
clean:
	rm *.o *.zip exec</code></pre>

<h3 id='implicit_rules'>Implicit Rules</h3>

<p>Make allows us to use a simplified syntax. For example we don’t always have to write a command for some targets. This is called an implicit rule:</p>

<pre><code>ana.o: ana.c</code></pre>

<p>Another implicit rule is that when running the command <code>make source.c</code>, the file source.c will be compiled even if there is no Makefile. Implicit rules use the environment variables. Thus, the example considered by us is equivalent to:</p>

<pre><code>ana.o: ana.c
	$(CC) -c $(LDFLAGS) ana.c -o ana.o</code></pre>

<p>Because implicit rules use environment variables, it is easy to modify their behavior by a simple change of the variables’ values.</p>

<h3 id='final_touches'>Final touches</h3>

<p>In many cases, the first target in a Makefile is a target that compiles all of the sources. It is very useful because we don’t have to specify a target every time we are running make.</p>

<p>Adding these changes to our example we get a complete Makefile:</p>

<pre><code>CC=gcc
LDFLAGS=-lm

all: exec

exec: ana.o are.o mere.o
	$(CC) $(LDFLAGS) $^ -o $@

foo.o: foo.c
	gcc -c foo.c -o foo.o
bar.o: bar.c
	gcc -c bar.c -o bar.o
main.o: main.c
	gcc -c main.c -o main.o

.PHONY: clean
	rm -rf *.o exec</code></pre>
    <hr/>
  </div>
</div>

<div id="container">
  <div class="entry-content">
    



<h2 class="clear">
  
  <a class="post_title" href="http://rosedu.github.com/techblog/making-your-shell-life-easier.html" title="Making your shell life easier">Making your shell life easier</a>
  
</h2>
<span class="date" 
  title="2012-04-30T00:00:00-07:00">
  <span class="published">Published on </span>
  <span class="day">30</span>
  <span class="month">April</span>
  <span class="year">2012</span>
  
  by
  <span class="author">Alexandru Juncu</span>
  
</span>


    <p>Most Linux users prefer to use the CLI because of its efficiency. But the days of the single terminal in which you had your shell are long gone. Users take advantage of the GUI and use graphical terminals like <a href='http://library.gnome.org/users/gnome-terminal/stable/gnome-terminal-get-started.html.en'><code>gnome-terminal</code></a>, <a href='http://konsole.kde.org/'><code>konsole</code></a> or similar utilities, to start several shell instances. For example if you are a programmer, you might want to have one instance for the editor (with the code you are working on), another one to test and debug the compiled executable and &#8211; maybe &#8211; another for the documentation (<code>man</code> pages). If you are a system administrator you might have a shell with the configuration file of a service, one you use to test the running service, and maybe one shell connected to another server. But having a lot of windows (or tabs) can get confusing.</p>

<p>Some prefer to optimize their environment and use a CLI-oriented Window Manager, like <a href='http://xmonad.org/'><code>xmonad</code></a>, to <em>productively manage windows without the use of the mouse</em>. But what if you can only get access to a single terminal, like in the case of a SSH client to a remote host? What if you don&#8217;t have a GUI, when configuring a server on-site? Or what if you just like to have one terminal window opened? What you can do is install terminal multiplexing programs like <a href='http://www.gnu.org/software/screen/'><code>screen</code></a> or <a href='http://tmux.sourceforge.net/'><code>tmux</code></a>. These programs fork several shell instances behind your primary shell instance and you can switch between them using keyboard shortcuts. Or you can learn to make use of things your shell (<a href='http://www.gnu.org/software/bash/'><code>bash</code></a>, for example) already offers you.</p>

<h3 id='lesson_1_dont_close_things_that_you_will_open_again_soon'>Lesson 1: Don&#8217;t close things that you will open again soon.</h3>

<p>If you are using your editor to write code or to change a configuration file and you want to compile the code or restart a service and test the result, you can send your editor into background with the <code>CTRL-Z</code> keyboard shortcut, that sends a <code>SIGTSTOP</code> signal to the process. You can run other command and then return to your edited file with the <code>fg</code> command. You may have several tasks in background for that shell instance. You can use the <code>jobs</code> command to see them and their jobid, and you can send a specific job in foreground with <code>fg
$JOBID</code>.</p>

<p>Some processes can not be sent into background with the <code>CTRL-Z</code> shortcut. For example, if you have a <code>ssh</code> connection to a remote server where the <code>CTRL-Z</code> will run not on the local host but on the remote host. In this case you will need to use the escape sequence of <code>[ENTER]~</code> and then send the <code>CTRL-Z</code> signal (you you need to press Enter, then the <code>~</code> key, then the <code>CTRL</code> and <code>Z</code> keys together).</p>

<p>Always try to take advantage of the current process&#8217; features. For example you can run <code>make</code> from a <code>vim</code> (or actually run any commands by prefixing them with a <code>!</code>) and you can <code>kill</code> a process from inside a <code>top</code> or <code>htop</code> process.</p>

<h3 id='lesson_2_save_paths_for_directories_you_need'>Lesson 2: Save paths for directories you need.</h3>

<p>Unlike a GUI, in a CLI you can go directly to a specific directory from the current one by <code>cd</code>-ing to an absolute or relative path (not going one directory at a time like in the GUI). But you shouldn&#8217;t always have to type the path. If you are going back and forth between two directories, use the <code>cd -</code> command to change directory to the last working directory you were in.</p>

<p>If you have several directories you are going to go through, but you know you will return to a specific one, you can use the directory stack to save that directory. You can <code>pushd $DIR</code> a directory into the stack and then <code>popd</code> to change into the top-of-stack directory.</p>

<p>Also, you can always use the reverse history (<code>CTRL-R</code>) to reuse commands already given.</p>

<pre><code>rosedu:~# cd /etc/apache2/sites-available/
rosedu:/etc/apache2/sites-available# cd /var/www/
rosedu:/var/www# cd -
/etc/apache2/sites-available
rosedu:/etc/apache2/sites-available# pushd
/etc/apache2/sites-available /etc/apache2/sites-available
rosedu:/etc/apache2/sites-available# cd /home
rosedu:/home# cd /etc/
rosedu:/etc# popd
/etc/apache2/sites-available
rosedu:/etc/apache2/sites-available#</code></pre>

<h3 id='lesson_3_always_know_who_and_where_you_are'>Lesson 3: Always know who and where you are.</h3>

<p>Some people open different terminals to keep track of what they are doing or where they are (and not change the location inside that terminal). The shell is made for having its current directory changes and it helps you know where you are with the <code>prompt</code>. A normal prompts looks like <code>user@host:current_path$</code>. It&#8217;s important to know with what user and on what machine you are logged in. The <code>$</code> and <code>#</code> characters will show you what privileges you have (either limited or administrator). The <code>current\_path</code> is usually the name of the current directory (but it can sometimes be a full path). If that doesn&#8217;t provide you enough information, use the <code>pwd</code> command to print the working directory or setup the <code>PS1</code> variabile to include more information.</p>

<p>Shells like <a href='http://www.gnu.org/software/bash/'><code>bash</code></a> have lots of not so well known tricks. But if you learn those tricks, they will make your life easier.</p>
    <hr/>
  </div>
</div>

<div id="container">
  <div class="entry-content">
    



<h2 class="clear">
  
  <a class="post_title" href="http://rosedu.github.com/techblog/valgrind-introduction.html" title="Valgrind introduction">Valgrind introduction</a>
  
</h2>
<span class="date" 
  title="2012-04-29T00:00:00-07:00">
  <span class="published">Published on </span>
  <span class="day">29</span>
  <span class="month">April</span>
  <span class="year">2012</span>
  
  by
  <span class="author">Mihai</span>
  
</span>


    <p>A good programmer has a variety of tools to help him in developing good applications. We talked about <a href='http://sources.redhat.com/gdb/'>gdb</a> in an <a href='http://techblog.rosedu.org/gdb-a-basic-workflow.html'>article</a> at the beginning of April. Now, it is time for a crash introduction to <a href='http://valgrind.org/'>Valgrind</a>.</p>

<p>This program is a collection of different tools. For example, it offers a <a href='http://valgrind.org/docs/manual/ms-manual.html'>heap profiler</a>, a <a href='http://valgrind.org/docs/manual/hg-manual.html'>thread error detector</a> or a <a href='http://valgrind.org/docs/manual/cg-manual.html'>cache profiler</a>. However, the tool which gave <a href='http://valgrind.org/'>Valgrind</a>&#8217;s fame is <a href='http://valgrind.org/docs/manual/mc-manual.html'>Memcheck</a>, a memory error detector. Because of its popularity, this tool is the default one (to use other <a href='http://valgrind.org/'>Valgrind</a> tools you have to use the <code>--tool=option</code> command line argument). In this article, we will concentrate on <a href='http://valgrind.org/docs/manual/mc-manual.html'>Memcheck</a> only.</p>

<h3 id='detecting_memory_leaks'>Detecting memory leaks</h3>

<p>Mainly, one would use <a href='http://valgrind.org/'>Valgrind</a> to detect memory leaks in his application. By this, we mean memory which was allocated but wasn&#8217;t released back. For example, take this program:</p>
<div class='highlight'><pre><code class='cpp'><span class='kt'>void</span> <span class='n'>f</span><span class='p'>()</span>
<span class='p'>{</span>
    <span class='kt'>int</span> <span class='o'>*</span><span class='n'>a</span> <span class='o'>=</span> <span class='n'>calloc</span><span class='p'>(</span><span class='mi'>1024</span><span class='p'>,</span> <span class='k'>sizeof</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>]));</span>
<span class='p'>}</span>

<span class='kt'>int</span> <span class='n'>main</span><span class='p'>()</span>
<span class='p'>{</span>
    <span class='kt'>int</span> <span class='n'>i</span><span class='p'>;</span>

    <span class='k'>for</span> <span class='p'>(</span><span class='n'>i</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span> <span class='n'>i</span> <span class='o'>&lt;</span> <span class='mi'>1024</span><span class='p'>;</span> <span class='n'>i</span><span class='o'>++</span><span class='p'>)</span>
        <span class='n'>f</span><span class='p'>();</span>

    <span class='k'>return</span> <span class='mi'>0</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>This program allocates <code>sizeof(int)</code> MB of memory and doesn&#8217;t free them. Of course, at the end of the execution, the operating systems takes care of releasing this memory. However, suppose that the <code>f</code> function was instead called from a server executable which shouldn&#8217;t be stopped. In this case, each invocation of <code>f</code> will eat away <code>sizeof(int)</code> KB memory (depending on architecture, 4KB or 8KB).</p>

<p>The example is simple, the problem could be observed with naked eyes. However, let&#8217;s see what <a href='http://valgrind.org/'>Valgrind</a> tells us:</p>

<pre><code>==11418== Memcheck, a memory error detector
==11418== Copyright (C) 2002-2011, and GNU GPL&#39;d, by Julian Seward et al.
==11418== Using Valgrind-3.7.0 and LibVEX; rerun with -h for copyright info
==11418== Command: ./a.out
==11418==
==11418==
==11418== HEAP SUMMARY:
==11418==     in use at exit: 4,194,304 bytes in 1,024 blocks
==11418==   total heap usage: 1,024 allocs, 0 frees, 4,194,304 bytes allocated
==11418==
==11418== LEAK SUMMARY:
==11418==    definitely lost: 4,194,304 bytes in 1,024 blocks
==11418==    indirectly lost: 0 bytes in 0 blocks
==11418==      possibly lost: 0 bytes in 0 blocks
==11418==    still reachable: 0 bytes in 0 blocks
==11418==         suppressed: 0 bytes in 0 blocks
==11418== Rerun with --leak-check=full to see details of leaked memory
==11418==
==11418== For counts of detected and suppressed errors, rerun with: -v
==11418== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 3 from 3)</code></pre>

<p>The number that gets repeated on each line of the output is the PID of our executable. At the end of the run, we are offered a heap summary (from where we can see that our program allocated 4MB of memory) and a leak summary.</p>

<p>Let&#8217;s see what happens after we take into account the suggestion to run with <code>--leak-check=full</code>. First, we compile the program adding debugging information, using the <code>-g</code> <a href='http://gcc.gnu.org/'>GCC</a> flag. And, then, we run the executable under <a href='http://valgrind.org/'>Valgrind</a>:</p>

<pre><code>mihai@keldon:/tmp/mm/valgrind$ valgrind --leak-check=full ./a.out
==11527== Memcheck, a memory error detector
==11527== Copyright (C) 2002-2011, and GNU GPL&#39;d, by Julian Seward et al.
==11527== Using Valgrind-3.7.0 and LibVEX; rerun with -h for copyright info
==11527== Command: ./a.out
==11527==
==11527==
==11527== HEAP SUMMARY:
==11527==     in use at exit: 4,194,304 bytes in 1,024 blocks
==11527==   total heap usage: 1,024 allocs, 0 frees, 4,194,304 bytes allocated
==11527==
==11527== 4,194,304 bytes in 1,024 blocks are definitely lost in loss record 1 of 1
==11527==    at 0x4C29024: calloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==11527==    by 0x4004F2: f (1.c:6)
==11527==    by 0x400513: main (1.c:14)
==11527==
==11527== LEAK SUMMARY:
==11527==    definitely lost: 4,194,304 bytes in 1,024 blocks
==11527==    indirectly lost: 0 bytes in 0 blocks
==11527==      possibly lost: 0 bytes in 0 blocks
==11527==    still reachable: 0 bytes in 0 blocks
==11527==         suppressed: 0 bytes in 0 blocks
==11527==
==11527== For counts of detected and suppressed errors, rerun with: -v
==11527== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 3 from 3)</code></pre>

<p>This time, we see that the memory was allocated in line 6 in function <code>f</code>. This allows us to insert the needed <code>free</code> at the correct spot.</p>

<p><strong>Quick question</strong>: what would have happened if our program was compiled with optimizations on (try <code>-O3</code> for example)?</p>

<h3 id='wrong_cases_of_memory_release'>Wrong cases of memory release</h3>

<p>What happens when we free the same memory address twice? Let&#8217;s use this program:</p>
<div class='highlight'><pre><code class='cpp'><span class='kt'>void</span> <span class='o'>*</span><span class='n'>f</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='kt'>int</span> <span class='o'>*</span><span class='n'>a</span> <span class='o'>=</span> <span class='n'>calloc</span><span class='p'>(</span><span class='mi'>16</span><span class='p'>,</span> <span class='k'>sizeof</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>]));</span>
	<span class='n'>free</span><span class='p'>(</span><span class='n'>a</span><span class='p'>);</span>
	<span class='k'>return</span> <span class='n'>a</span><span class='p'>;</span>
<span class='p'>}</span>

<span class='kt'>int</span> <span class='n'>main</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='kt'>int</span> <span class='o'>*</span><span class='n'>a</span> <span class='o'>=</span> <span class='n'>f</span><span class='p'>();</span>
	<span class='n'>free</span><span class='p'>(</span><span class='n'>a</span><span class='p'>);</span>
	<span class='k'>return</span> <span class='mi'>0</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>Running it with <a href='http://valgrind.org/'>Valgrind</a> yields:</p>

<pre><code>mihai@keldon:/tmp/mm/valgrind$ valgrind ./a.out
==11734== Memcheck, a memory error detector
==11734== Copyright (C) 2002-2011, and GNU GPL&#39;d, by Julian Seward et al.
==11734== Using Valgrind-3.7.0 and LibVEX; rerun with -h for copyright info
==11734== Command: ./a.out
==11734==
==11734== Invalid free() / delete / delete[] / realloc()
==11734==    at 0x4C29A9E: free (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==11734==    by 0x40057A: main (1.c:14)
==11734==  Address 0x51d2040 is 0 bytes inside a block of size 64 free&#39;d
==11734==    at 0x4C29A9E: free (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==11734==    by 0x400552: f (1.c:7)
==11734==    by 0x40056A: main (1.c:13)
==11734==
==11734==
==11734== HEAP SUMMARY:
==11734==     in use at exit: 0 bytes in 0 blocks
==11734==   total heap usage: 1 allocs, 2 frees, 64 bytes allocated
==11734==
==11734== All heap blocks were freed -- no leaks are possible
==11734==
==11734== For counts of detected and suppressed errors, rerun with: -v
==11734== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 3 from 3)</code></pre>

<p>We can see both locations where the memory was released.</p>

<p>Now, consider this C++ code, a tweaked version of the above:</p>
<div class='highlight'><pre><code class='cpp'><span class='kt'>int</span> <span class='o'>*</span><span class='n'>f</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='kt'>int</span> <span class='o'>*</span><span class='n'>a</span> <span class='o'>=</span> <span class='p'>(</span><span class='kt'>int</span> <span class='o'>*</span><span class='p'>)</span><span class='n'>calloc</span><span class='p'>(</span><span class='mi'>16</span><span class='p'>,</span> <span class='k'>sizeof</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>]));</span>
	<span class='k'>return</span> <span class='n'>a</span><span class='p'>;</span>
<span class='p'>}</span>

<span class='kt'>int</span> <span class='n'>main</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='kt'>int</span> <span class='o'>*</span><span class='n'>a</span> <span class='o'>=</span> <span class='n'>f</span><span class='p'>();</span>
	<span class='k'>delete</span> <span class='n'>a</span><span class='p'>;</span>
	<span class='k'>return</span> <span class='mi'>0</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>Running under <a href='http://valgrind.org/'>Valgrind</a>, we receive the following output (we will use <code>-q</code> to show only the errors reported by Valgrind &#8211; no header and no statistics at the end):</p>

<pre><code>mihai@keldon:/tmp/mm/valgrind$ valgrind -q ./a.out
==11757== Mismatched free() / delete / delete []
==11757==    at 0x4C2972C: operator delete(void*) (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==11757==    by 0x400659: main (1.c:13)
==11757==  Address 0x59e0040 is 0 bytes inside a block of size 64 alloc&#39;d
==11757==    at 0x4C29024: calloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==11757==    by 0x400632: f() (1.c:6)
==11757==    by 0x400649: main (1.c:12)</code></pre>

<p>Before finishing this section, let&#8217;s consider the case of freeing from inside an allocated block. See this code:</p>
<div class='highlight'><pre><code class='cpp'><span class='kt'>void</span> <span class='o'>*</span><span class='n'>f</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='kt'>int</span> <span class='o'>*</span><span class='n'>a</span> <span class='o'>=</span> <span class='n'>calloc</span><span class='p'>(</span><span class='mi'>16</span><span class='p'>,</span> <span class='k'>sizeof</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>]));</span>
	<span class='k'>return</span> <span class='n'>a</span> <span class='o'>+</span> <span class='mi'>4</span><span class='p'>;</span>
<span class='p'>}</span>

<span class='kt'>int</span> <span class='n'>main</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='kt'>int</span> <span class='o'>*</span><span class='n'>a</span> <span class='o'>=</span> <span class='n'>f</span><span class='p'>();</span>
	<span class='n'>free</span><span class='p'>(</span><span class='n'>a</span><span class='p'>);</span>
	<span class='k'>return</span> <span class='mi'>0</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p><a href='http://valgrind.org/'>Valgrind</a> gives the following output:</p>

<pre><code>mihai@keldon:/tmp/mm/valgrind$ valgrind -q ./a.out
==11765== Invalid free() / delete / delete[] / realloc()
==11765==    at 0x4C29A9E: free (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==11765==    by 0x400572: main (1.c:13)
==11765==  Address 0x51d2050 is 16 bytes inside a block of size 64 alloc&#39;d
==11765==    at 0x4C29024: calloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==11765==    by 0x400542: f (1.c:6)
==11765==    by 0x400562: main (1.c:12)</code></pre>

<p>From this we can easily see that we tried to free from inside an allocated block instead of using the block&#8217;s address. Moreover, we find where the block was allocated and we can fix our program now.</p>

<h3 id='incorrect_usage_of_memory'>Incorrect usage of memory</h3>

<p>Let&#8217;s see this simple code:</p>
<div class='highlight'><pre><code class='cpp'><span class='k'>struct</span> <span class='n'>s</span> <span class='p'>{</span>
	<span class='kt'>int</span> <span class='n'>a</span><span class='p'>,</span> <span class='n'>b</span><span class='p'>;</span>
<span class='p'>};</span>

<span class='kt'>int</span> <span class='n'>main</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='k'>struct</span> <span class='n'>s</span> <span class='n'>s</span><span class='p'>;</span>
	<span class='n'>s</span><span class='p'>.</span><span class='n'>a</span> <span class='o'>=</span> <span class='mi'>42</span><span class='p'>;</span>
	<span class='k'>if</span> <span class='p'>(</span><span class='n'>s</span><span class='p'>.</span><span class='n'>b</span><span class='p'>)</span>
		<span class='n'>printf</span><span class='p'>(</span><span class='s'>&quot;s.b</span><span class='se'>\n</span><span class='s'>&quot;</span><span class='p'>);</span>
	<span class='k'>return</span> <span class='mi'>0</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>We didn&#8217;t initialize <code>s.b</code>. <a href='http://valgrind.org/'>Valgrind</a> reports this:</p>

<pre><code>mihai@keldon:/tmp/mm/valgrind$ valgrind -q ./a.out
==11868== Conditional jump or move depends on uninitialised value(s)
==11868==    at 0x4004F0: main (1.c:12)
==11868==</code></pre>

<p>This was simple. Now, consider this common case:</p>
<div class='highlight'><pre><code class='cpp'><span class='kt'>int</span> <span class='n'>main</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='kt'>char</span> <span class='o'>*</span><span class='n'>s</span> <span class='o'>=</span> <span class='n'>strdup</span><span class='p'>(</span><span class='s'>&quot;Valgrind rocks&quot;</span><span class='p'>);</span>
	<span class='kt'>char</span> <span class='o'>*</span><span class='n'>q</span> <span class='o'>=</span> <span class='n'>malloc</span><span class='p'>(</span><span class='n'>strlen</span><span class='p'>(</span><span class='n'>s</span><span class='p'>));</span>
	<span class='n'>strcpy</span><span class='p'>(</span><span class='n'>q</span><span class='p'>,</span> <span class='n'>s</span><span class='p'>);</span>
	<span class='k'>return</span> <span class='mi'>0</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>This code looks perfectly valid. Does it? <a href='http://valgrind.org/'>Valgrind</a> says otherwise:</p>

<pre><code>mihai@keldon:/tmp/mm/valgrind$ valgrind -q ./a.out
==12038== Invalid write of size 1
==12038==    at 0x4C2B27F: strcpy (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==12038==    by 0x4005FC: main (1.c:9)
==12038==  Address 0x51d209e is 0 bytes after a block of size 14 alloc&#39;d
==12038==    at 0x4C2A93D: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==12038==    by 0x4005E5: main (1.c:8)</code></pre>

<p>Indeed, we missed space for the <code>\0</code> terminating character. Suppose we do this fix: we change <code>strcpy(q, s)</code> with <code>strcpy(q, s + 1)</code>. This works.</p>

<p>Now, let us assume that &#8211; by mistake &#8211; we also change <code>q</code>:</p>
<div class='highlight'><pre><code class='cpp'><span class='kt'>int</span> <span class='n'>main</span><span class='p'>()</span>
<span class='p'>{</span>
	<span class='kt'>char</span> <span class='o'>*</span><span class='n'>s</span> <span class='o'>=</span> <span class='n'>strdup</span><span class='p'>(</span><span class='s'>&quot;Valgrind rocks&quot;</span><span class='p'>);</span>
	<span class='n'>strcpy</span><span class='p'>(</span><span class='n'>s</span><span class='p'>,</span> <span class='n'>s</span> <span class='o'>+</span> <span class='mi'>1</span><span class='p'>);</span>
	<span class='k'>return</span> <span class='mi'>0</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p><a href='http://valgrind.org/'>Valgrind</a> is prompt to show us that we use <code>strcpy</code> in a wrong way, possibly destroying content:</p>

<pre><code>mihai@keldon:/tmp/mm/valgrind$ valgrind -q ./a.out
==12058== Source and destination overlap in strcpy(0x51d2040, 0x51d2041)
==12058==    at 0x4C2B2F5: strcpy (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==12058==    by 0x400600: main (1.c:9)</code></pre>

<p>But what if that was the indented behaviour? What if we really needed to remove the first letter of <code>s</code>?</p>

<p>We can generate a suppression and use it in other calls of <a href='http://valgrind.org/'>Valgrind</a> to ignore this error. To generate it, we use another flag:</p>

<pre><code>mihai@keldon:/tmp/mm/valgrind$ valgrind --gen-suppressions=yes -q ./a.out
==12079== Source and destination overlap in strcpy(0x51d2040, 0x51d2041)
==12079==    at 0x4C2B2F5: strcpy (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==12079==    by 0x400600: main (1.c:9)
==12079==
==12079==
==12079== ---- Print suppression ? --- [Return/N/n/Y/y/C/c] ---- y
{
   &lt;insert_a_suppression_name_here&gt;
   Memcheck:Overlap
   fun:strcpy
   fun:main
}</code></pre>

<p>We copy the printed lines into a file, <code>strcpy_main.supp</code>:</p>

<pre><code>{
   strcpy_main
   Memcheck:Overlap
   fun:strcpy
   fun:main
}</code></pre>

<p>When we run <a href='http://valgrind.org/'>Valgrind</a> again, we will use this file to ignore that error.</p>

<pre><code>mihai@keldon:/tmp/mm/valgrind$ valgrind --suppressions=strcpy_main.supp -q ./a.out
mihai@keldon:/tmp/mm/valgrind$</code></pre>

<p>Even though this works, we should not use <code>strcpy</code> with overlapping arguments. The manual page for <code>strcpy</code> tells:</p>

<pre><code>The  strcpy()  function  copies  the  string pointed to by src, including
the terminating null byte (&#39;\0&#39;), to the buffer pointed to by dest. The
strings may not overlap, and the destination string dest must be large
enough to receive the copy.</code></pre>

<p>One last word before finishing this article. If your program has too many errors, <a href='http://valgrind.org/'>Valgrind</a> tries to be funny and gives the following message:</p>

<pre><code>==21573== More than 10000000 total errors detected.  I&#39;m not reporting any more.
==21573== Final error counts will be inaccurate.  Go fix your program!</code></pre>

<p>You should do this, of course.</p>

<p>In a later article we will show how can you combine <a href='http://valgrind.org/'>Valgrind</a> and <a href='http://sources.redhat.com/gdb/'>GDB</a> to fix some nasty bugs. But until then, remember how to use <a href='http://valgrind.org/docs/manual/mc-manual.html'>Memcheck</a> and keep in mind that <a href='http://valgrind.org/'>Valgrind</a> has many useful tools and a programmer can create others if he needs them.</p>
    <hr/>
  </div>
</div>



    </div>
    <div id="footer" style="text-align:center;">
      <span>
        <a rel="license" href="http://creativecommons.org/licenses/by/3.0/">
          <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by/3.0/88x31.png" />
        </a>
      </span>
      <span style="vertical-align:0.5em;">
        This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/">
          Creative Commons Attribution 3.0 License
        </a>.
      </span>
    </div>
  </body>
</html>
<script src="http://dserban.github.com/js/zepto.min.js"></script>

